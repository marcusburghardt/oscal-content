name: quality-test
# https://issues.redhat.com/browse/CPLYTM-254

on:
  pull_request:

permissions:
  contents: read

jobs:
  quality-test-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Install complyctl and testing environment packages
        run: |
          dnf update -y
          dnf install -y complyctl complyctl-openscap-plugin scap-security-guide git jq xmlstarlet bc

      # Checkout the code from the repository
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get all changed files
        id: changed-files
        uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c # v46.0.5
        with:
          # Only get cusp fedora related files
          files: |
            catalogs/**
            profiles/fedora-cusp_fedora*/**
            component-definitions/fedora/fedora-cusp_fedora*/**

      # group changed files into catalogs, profiles, component-definitions
      - name: Group changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        id: group-files
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          catalogs=()
          profiles=()
          component_definitions=()
                    
          for file in $ALL_CHANGED_FILES; do
            case "$file" in
              *profiles*)
                profiles+=("$file")
                ;;
              *component-definitions*)
                component_definitions+=("$file")
                ;;
              *catalogs*)
                catalogs+=("$file")
                ;;
            esac
          done
          
          # Join elements into a space-delimited string
          catalogs_string=$(printf "%s " "${catalogs[@]}")
          profiles_string=$(printf "%s " "${profiles[@]}")
          component_definitions_string=$(printf "%s " "${component_definitions[@]}")
          
          echo "catalogs=$catalogs_string" >> $GITHUB_OUTPUT 
          echo "profiles=$profiles_string" >> $GITHUB_OUTPUT 
          echo "component_definitions=$component_definitions_string" >> $GITHUB_OUTPUT 

      # first cd , then profile, last catalog
      - name: Test changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        shell: bash
        run: |
          ./scripts/verify-OSCAL-contents.sh \
          "${{ steps.group-files.outputs.catalogs }}" \
          "${{ steps.group-files.outputs.profiles }}" \
          "${{ steps.group-files.outputs.component_definitions }}" \
          "fedora"
